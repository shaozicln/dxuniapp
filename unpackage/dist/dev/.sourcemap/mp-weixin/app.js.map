{"version":3,"file":"app.js","sources":["App.vue","main.js"],"sourcesContent":["<script>\r\n\texport default {\r\n\t\tdata() {\r\n\t\t\treturn {\r\n\t\t\t\t// 标记：是否已完成首次登录态检查（防止 onShow 重复触发）\r\n\t\t\t\thasInitedLoginCheck: false,\r\n\t\t\t\tPAGE_PATHS: {\r\n\t\t\t\t\tLOGIN: '/pages/login/login', \r\n\t\t\t\t\tINDEX: '/pages/index/index',\r\n\t\t\t\t\tMY: '/pages/my/my'\r\n\t\t\t\t},\r\n\t\t\t\tAUTHORIZED_PAGES: [] // 初始为空，在 onLaunch 中初始化\r\n\t\t\t}\r\n\t\t},\r\n\t\tonLaunch: function() {\r\n\t\t\tconsole.log('App Launch');\r\n\t\t\t// 初始化已授权页面白名单（使用统一路径配置，避免错误）\r\n\t\t\tthis.AUTHORIZED_PAGES = [\r\n\t\t\t\tthis.PAGE_PATHS.INDEX,\r\n\t\t\t\tthis.PAGE_PATHS.MY\r\n\t\t\t];\r\n\t\t\tsetTimeout(() => {\r\n\t\t\t\tthis.checkOpenidStatus();\r\n\t\t\t\tthis.hasInitedLoginCheck = true;\r\n\t\t\t}, 300);\r\n\t\t},\r\n\t\tonShow: function() {\r\n\t\t\tconsole.log('App Show');\r\n\t\t\t// 控制 onShow 触发时机：仅在“首次检查未完成”或“从后台切回且登录态可能变化”时执行\r\n\t\t\tif (!this.hasInitedLoginCheck) {\r\n\t\t\t\tthis.checkOpenidStatus();\r\n\t\t\t\tthis.hasInitedLoginCheck = true;\r\n\t\t\t} else {\r\n\t\t\t\t// 场景2：从后台切回，仅在“登录态存在变化风险”时检查（如用户可能在其他端登出）\r\n\t\t\t\t// 优化：可增加“切后台时间判断”，超过 30 分钟才重新检查（避免频繁执行）\r\n\t\t\t\tconst lastHideTime = this.$options.globalData.lastHideTime || 0;\r\n\t\t\t\tconst currentTime = Date.now();\r\n\t\t\t\tif (currentTime - lastHideTime > 30 * 60 * 1000) { // 30分钟\r\n\t\t\t\t\tthis.checkOpenidStatus();\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t},\r\n\t\tonHide: function() {\r\n\t\t\tconsole.log('App Hide');\r\n\t\t\t// 记录切后台时间（用于 onShow 时判断是否需要重新检查登录态）\r\n\t\t\tthis.$options.globalData.lastHideTime = Date.now();\r\n\t\t},\r\n\t\tmethods: {\r\n\t\t\t// 封装：检查 openid 登录态 + 控制跳转（核心优化）\r\n\t\t\tcheckOpenidStatus() {\r\n\t\t\t\t// 1. 读取 openid（增加异常捕获，避免存储读取失败导致逻辑中断）\r\n\t\t\t\tlet openid = '';\r\n\t\t\t\ttry {\r\n\t\t\t\t\topenid = uni.getStorageSync('openid') || '';\r\n\t\t\t\t} catch (err) {\r\n\t\t\t\t\tconsole.error('读取 openid 失败：', err);\r\n\t\t\t\t\topenid = '';\r\n\t\t\t\t}\r\n\t\t\t\tconst pages = getCurrentPages();\r\n\t\t\t\tconst currentPage = pages.length > 0 ? pages[pages.length - 1].route : '';\r\n\t\t\t\tconst currentPageWithPrefix = currentPage ? `/${currentPage}` : '';\r\n\t\t\t\tconsole.log('当前页面路径：', currentPageWithPrefix);\r\n\t\t\t\t// 登录态判断 + 跳转控制（核心逻辑：仅在“当前页不符合权限”时跳转）\r\n\t\t\t\tif (openid) {\r\n\t\t\t\t\t// 已登录：判断当前页是否在授权白名单内\r\n\t\t\t\t\tif (!this.AUTHORIZED_PAGES.includes(currentPageWithPrefix)) {\r\n\t\t\t\t\t\t// 未在白名单 → 跳首页（避免重复跳转：先判断是否已在首页）\r\n\t\t\t\t\t\tif (currentPageWithPrefix !== this.PAGE_PATHS.INDEX) {\r\n\t\t\t\t\t\t\tthis.redirectToPage(this.PAGE_PATHS.INDEX, '首页');\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t} else {\r\n\t\t\t\t\tif (currentPageWithPrefix !== this.PAGE_PATHS.LOGIN) {\r\n\t\t\t\t\t\tthis.redirectToPage(this.PAGE_PATHS.LOGIN, '登录页');\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t},\r\n\t\t\t// 封装：统一跳转方法\r\n\t\t\tredirectToPage(targetPath, pageName) {\r\n\t\t\t\t// 先校验目标路径是否存在\r\n\t\t\t\tconst pagesConfig = uni.getAppBaseInfo().pages || [];\r\n\t\t\t\tconst isPathValid = pagesConfig.some(page => page.path === targetPath.slice(1)); \r\n\t\t\t\tif (!isPathValid) {\r\n\t\t\t\t\tconsole.error(`跳转失败：${pageName}路径${targetPath}未在 pages.json 中注册`);\r\n\t\t\t\t\treturn;\r\n\t\t\t\t}\r\n\t\t\t\t// 执行跳转（用 redirectTo 关闭当前页，防止返回无效页面）\r\n\t\t\t\tuni.redirectTo({\r\n\t\t\t\t\turl: targetPath,\r\n\t\t\t\t\tsuccess: () => {\r\n\t\t\t\t\t\tconsole.log(`跳转${pageName}成功`);\r\n\t\t\t\t\t},\r\n\t\t\t\t\tfail: (err) => {\r\n\t\t\t\t\t\t// 特殊处理：若目标是 tabbar 页，redirectTo 会失败，自动切换为 switchTab\r\n\t\t\t\t\t\tif (err.errMsg.includes('can not redirectTo a tabbar page')) {\r\n\t\t\t\t\t\t\tconsole.warn(`(${pageName}是 tabbar 页) 自动切换为 switchTab 跳转`);\r\n\t\t\t\t\t\t\tuni.switchTab({\r\n\t\t\t\t\t\t\t\turl: targetPath,\r\n\t\t\t\t\t\t\t\tsuccess: () => console.log(`switchTab 跳转${pageName}成功`),\r\n\t\t\t\t\t\t\t\tfail: (tabErr) => console.error(`switchTab 跳转${pageName}失败：`, tabErr)\r\n\t\t\t\t\t\t\t});\r\n\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\tconsole.error(`跳转${pageName}失败：`, err);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t},\r\n\t\t// 全局数据：存储切后台时间（跨生命周期访问）\r\n\t\tglobalData: {\r\n\t\t\tlastHideTime: 0\r\n\t\t}\r\n\t}\r\n</script>\r\n\r\n<style>\r\n\tbody {\r\n\t\tmargin: 0;\r\n\t\tpadding: 0;\r\n\t}\r\n</style>","//https://jxpj.neau.edu.cn/api/v1\r\nimport App from './App'\r\nimport { request, get, post, put, del } from '@/utils/request/request.js'\r\n\r\n// #ifndef VUE3\r\nimport Vue from 'vue'\r\nimport './uni.promisify.adaptor'\r\n\r\n// 全局注册基础URL\r\nVue.prototype.$URL = 'http://localhost:8080'\r\n\r\n// 全局注册请求方法\r\nVue.prototype.$request = request\r\nVue.prototype.$get = get\r\nVue.prototype.$post = post\r\nVue.prototype.$put = put\r\nVue.prototype.$del = del\r\n\r\nVue.config.productionTip = false\r\nApp.mpType = 'app'\r\nconst app = new Vue({\r\n  ...App\r\n})\r\napp.$mount()\r\n// #endif\r\n\r\n// #ifdef VUE3\r\nimport { createSSRApp } from 'vue'\r\n\r\nexport function createApp() {\r\n  const app = createSSRApp(App)\r\n  \r\n  app.config.globalProperties.$URL = 'http://localhost:8080'\r\n  \r\n  app.config.globalProperties.$request = request\r\n  app.config.globalProperties.$get = get\r\n  app.config.globalProperties.$post = post\r\n  app.config.globalProperties.$put = put\r\n  app.config.globalProperties.$del = del\r\n  \r\n  return {\r\n    app\r\n  }\r\n}\r\n// #endif"],"names":["uni","createSSRApp","App","request","get","post","put","del"],"mappings":"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"}